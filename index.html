<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids' Daily Helper</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        /* CSS Variables for Easier Theming - Keep these consistent! */
        :root {
            --primary-color: #6a11cb; /* A fun purple */
            --secondary-color: #2575fc; /* A bright blue */
            --text-color: #333;
            --light-text-color: #6c757d;
            --background-gradient: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            --white-background: white;
            --light-background: #f8f9fa;
            --border-color: #e9ecef;
            --active-border-color: var(--primary-color);
            --active-background-light: #e0f2f7; /* Light blue/purple tint */
            --success-color: #28a745;
            --danger-color: #dc3545;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --shadow: 0 0 50px rgba(0,0,0,0.3);
            --border-radius-card: 12px;
            --border-radius-btn: 25px;
            --border-radius-input: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--background-gradient);
            min-height: 100vh;
            color: var(--text-color);
            overflow-x: hidden;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--white-background);
            min-height: 100vh;
            position: relative;
            box-shadow: var(--shadow);
        }

        .header {
            background: var(--background-gradient);
            color: var(--white-background);
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 10; /* Ensure header is above other content for dropdown */
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
            margin-bottom: 10px; /* Space for selector */
        }

        .child-selector {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 1rem;
            color: white;
            cursor: pointer;
            -webkit-appearance: none; /* Remove default dropdown arrow on iOS */
            -moz-appearance: none; /* Remove default dropdown arrow on Firefox */
            appearance: none; /* Remove default dropdown arrow */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 18px;
            width: calc(100% - 40px); /* Adjust width */
            max-width: 200px;
            text-align: center;
            text-align-last: center; /* Center selected option text */
            margin-top: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .child-selector option {
            background: var(--background-gradient); /* Darker background for options */
            color: white;
        }

        .manage-children-btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .manage-children-btn:hover {
            background: rgba(255,255,255,0.2);
        }


        .nav-tabs {
            display: flex;
            background: var(--light-background);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--light-text-color);
            transition: all 0.2s ease;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            background: var(--white-background);
        }

        .tab-content {
            display: none;
            padding: 20px;
            min-height: calc(100vh - 140px); /* Adjust based on header/nav height */
        }

        .tab-content.active {
            display: block;
        }

        /* Activity Chooser Specific Styles */
        .activity-chooser {
            text-align: center;
            padding-top: 40px;
        }

        .activity-display {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        .activity-display .emoji {
            font-size: 4rem;
            display: block;
            margin-bottom: 10px;
        }
        .activity-display .name {
            font-weight: 700;
            color: var(--primary-color);
        }

        .activity-controls {
            margin-top: 30px;
        }

        /* Chore Tracker Specific Styles */
        .chore-tracker {
            padding-top: 20px;
        }

        .points-today {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .chore-list {
            margin-bottom: 20px;
        }

        .chore-item {
            display: flex;
            align-items: center;
            background: var(--light-background);
            border-radius: var(--border-radius-card);
            padding: 12px 16px;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .chore-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px; /* Larger checkbox */
            height: 20px;
            flex-shrink: 0;
            cursor: pointer;
        }
        .chore-item label {
            flex-grow: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chore-item label.completed {
            text-decoration: line-through;
            color: var(--light-text-color);
        }
        .chore-item .points {
            font-size: 0.85rem;
            color: var(--light-text-color);
            margin-left: auto;
            font-weight: 500;
        }

        .manage-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-btn);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 10px;
        }
        .manage-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        /* Rewards Tab Specific Styles */
        .rewards-section {
            padding-top: 20px;
        }

        .total-points-display {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        .total-points-display small {
            font-size: 0.8rem;
            color: var(--light-text-color);
            display: block;
            margin-top: 5px;
        }

        .reward-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns */
            gap: 15px;
            margin-bottom: 20px;
        }

        .reward-card {
            background: var(--light-background);
            padding: 15px;
            border-radius: var(--border-radius-card);
            text-align: center;
            border: 2px solid var(--border-color);
            opacity: 0.6;
            transition: all 0.2s ease;
        }
        .reward-card.unlocked {
            opacity: 1;
            border-color: var(--success-color);
            background: #e6ffee; /* Light green */
        }
        .reward-card .emoji {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        .reward-card .name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        .reward-card .cost {
            font-size: 0.75rem;
            color: var(--light-text-color);
            margin-top: 5px;
        }

        /* Modals (Common styles) */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: var(--white-background);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-content h3 {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text-color);
            padding: 0;
            line-height: 1;
        }
        .modal-close-btn:hover {
            color: var(--text-color);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
        .form-group input[type="text"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-input);
            font-size: 1rem;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Reusable item list (for activities/chores in manage-modal, and children in child-management-modal) */
        .modal-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--light-background);
            border-radius: var(--border-radius-input);
            margin-bottom: 10px;
            position: relative;
        }
        .modal-item input[type="text"] {
            flex: 1;
            border: none;
            background: none;
            font-size: 0.9rem;
            padding: 0;
        }
        .modal-item input[type="number"] {
            width: 70px;
            flex-shrink: 0;
            border: none;
            background: none;
            text-align: right;
            -moz-appearance: textfield;
        }
        .modal-item input[type="number"]::-webkit-outer-spin-button,
        .modal-item input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .modal-item .remove-btn,
        .modal-item .edit-btn { /* For child list in modal */
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 5px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
            margin-left: auto; /* Push buttons to right */
        }
        .modal-item .remove-btn { color: var(--danger-color); }
        .modal-item .edit-btn { color: var(--primary-color); margin-left: 0; } /* Align next to name */

        .modal-item .remove-btn:hover,
        .modal-item .edit-btn:hover {
            opacity: 1;
        }

        .modal-item .emoji-selector { /* For in-line emoji selection on activities/chores */
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            background: none;
            border: none;
        }

        /* Full Emoji Picker (for Child Management) */
        .full-emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .full-emoji-picker .emoji-option {
            padding: 8px;
            border: none;
            background: var(--light-background);
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }
        .full-emoji-picker .emoji-option:hover,
        .full-emoji-picker .emoji-option.selected {
            background: var(--primary-color);
            color: var(--white-background);
        }

        /* General Utility Styles */
        .hidden {
            display: none !important;
        }
        .completion-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            z-index: 1001;
            animation: celebrationPop 1s ease-out forwards;
            pointer-events: none;
        }
        @keyframes celebrationPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        /* Motivational message animations */
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        }

        /* Accessibility focus styles */
        .keyboard-navigation button:focus,
        .keyboard-navigation input:focus,
        .keyboard-navigation select:focus, /* Added for new dropdown */
        .keyboard-navigation .manage-button:focus,
        .keyboard-navigation .reward-card:focus,
        .keyboard-navigation .manage-children-btn:focus,
        .keyboard-navigation .modal-item .edit-btn:focus,
        .keyboard-navigation .modal-item .remove-btn:focus,
        .keyboard-navigation .full-emoji-picker .emoji-option:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Kids' Daily Helper</h1>
            <p>Fun activities & easy chores!</p>
            <select id="child-selector" class="child-selector" onchange="switchChild(this.value)">
                </select>
            <button class="manage-children-btn" onclick="showChildManagementModal()">Manage Children</button>
            </div>

        <div class="nav-tabs">
            <button class="tab active" onclick="switchTab('activities')">Activities</button>
            <button class="tab" onclick="switchTab('chores')">Chores</button>
            <button class="tab" onclick="switchTab('rewards')">Rewards</button>
        </div>

        <div id="activities" class="tab-content active">
            <div class="activity-chooser">
                <p style="color: var(--light-text-color); margin-bottom: 20px;">What should we do now?</p>
                <div class="activity-display">
                    <span class="emoji" id="current-activity-emoji">‚ùì</span>
                    <span class="name" id="current-activity-name">Let's Find Out!</span>
                </div>
                <div class="activity-controls">
                    <button class="btn" onclick="pickRandomActivity()" style="margin-bottom: 10px;">Pick an Activity!</button>
                    <button class="manage-button" onclick="showManageModal('activity')">Manage Activities</button>
                </div>
            </div>
        </div>

        <div id="chores" class="tab-content">
            <div class="chore-tracker">
                <div class="points-today">Today's Points: <span id="today-points-display">0</span></div>
                <div id="chores-list" class="chore-list">
                    </div>
                <button class="manage-button" onclick="showManageModal('chore')">Manage Chores</button>
                <button class="manage-button secondary" onclick="resetChores()">Reset Chores (Manual)</button>
            </div>
        </div>

        <div id="rewards" class="tab-content">
            <div class="rewards-section">
                <div class="total-points-display">
                    <span id="total-points-display">0</span> Points
                    <small>Earn points by completing chores!</small>
                </div>
                <h3 style="margin-bottom: 15px; text-align: center; color: var(--text-color);">Unlockables</h3>
                <div id="rewards-grid" class="reward-grid">
                    </div>
                <p id="no-rewards-msg" style="color: var(--light-text-color); margin-top: 20px; text-align: center;">Keep earning points to unlock fun rewards!</p>
            </div>
        </div>
    </div>

    <div id="manage-modal" class="modal">
        <div class="modal-content">
            <h3><span id="modal-title">Manage Items</span> <button class="modal-close-btn" onclick="hideManageModal()">&times;</button></h3>
            
            <div class="form-group">
                <div id="item-list-container">
                    </div>
            </div>
            <button type="button" class="btn" onclick="addNewItemToModal()" style="margin-top: 10px; padding: 8px 16px;">+ Add New Item</button>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn secondary" onclick="hideManageModal()" style="flex: 1;">Cancel</button>
                <button class="btn" id="save-items-btn" onclick="saveManagedItems()" style="flex: 1;">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="child-management-modal" class="modal">
        <div class="modal-content">
            <h3><span id="child-modal-title">Manage Children</span> <button class="modal-close-btn" onclick="hideChildManagementModal()">&times;</button></h3>
            
            <div id="add-edit-child-form">
                <div class="form-group">
                    <label for="child-name-input">Name</label>
                    <input type="text" id="child-name-input" placeholder="Child's Name" />
                </div>
                <div class="form-group" style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label for="child-age-input">Age</label>
                        <input type="number" id="child-age-input" placeholder="Age" min="1" max="18" />
                    </div>
                    <div style="flex: 1;">
                        <label>Emoji</label>
                        <button type="button" id="child-emoji-display" class="emoji-selector" style="width: 100%; height: 48px; border: 2px solid var(--border-color); border-radius: var(--border-radius-input); font-size: 1.5rem;">üëß</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="full-emoji-picker" id="child-emoji-picker">
                        </div>
                </div>
                <button class="btn" id="save-child-btn" onclick="saveChild()" style="width: 100%; margin-bottom: 20px;">Add Child</button>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 25px 0;">

            <h4 style="margin-bottom: 15px; color: var(--text-color);">Existing Children</h4>
            <div id="children-list-management">
                </div>
            <p id="no-children-msg" class="hidden" style="color: var(--light-text-color); text-align: center;">No children added yet!</p>
        </div>
    </div>
    <script>
        // --- Application State ---
        let activities = JSON.parse(localStorage.getItem('activities') || '[]');
        let children = JSON.parse(localStorage.getItem('children') || '[]'); // Main data structure for children
        let currentChildIndex = -1; // Index of the currently selected child in the 'children' array
        let editingChildId = null; // ID of the child currently being edited in the child management modal

        // Default Data (only if localStorage is empty for children)
        if (children.length === 0) {
            children = [
                {
                    id: 1,
                    name: "Riley", // Age 8
                    age: 8,
                    emoji: "üëß",
                    totalPoints: 0,
                    todayPoints: 0,
                    lastChoreResetDate: null,
                    chores: [
                        { id: 1, name: "Make Bed", emoji: "üõèÔ∏è", points: 10, completed: false },
                        { id: 2, name: "Brush Teeth", emoji: "ü¶∑", points: 5, completed: false },
                        { id: 3, name: "Set Table", emoji: "üçΩÔ∏è", points: 10, completed: false },
                        { id: 4, name: "Load Dishwasher", emoji: "üß∫", points: 20, completed: false },
                        { id: 5, name: "Tidy Room", emoji: "üßπ", points: 15, completed: false },
                        { id: 6, name: "Feed Pets", emoji: "üêæ", points: 10, completed: false }
                    ],
                    unlockedRewards: []
                },
                {
                    id: 2,
                    name: "Phoenix", // Age 6
                    age: 6,
                    emoji: "üßí",
                    totalPoints: 0,
                    todayPoints: 0,
                    lastChoreResetDate: null,
                    chores: [
                        { id: 1, name: "Make Bed", emoji: "üõèÔ∏è", points: 10, completed: false },
                        { id: 2, name: "Brush Teeth", emoji: "ü¶∑", points: 5, completed: false },
                        { id: 3, name: "Put Away Toys", emoji: "üß∏", points: 15, completed: false },
                        { id: 4, name: "Put Clothes in Hamper", emoji: "üëï", points: 10, completed: false },
                        { id: 5, name: "Wipe Up Spills", emoji: "üíß", points: 5, completed: false }
                    ],
                    unlockedRewards: []
                },
                {
                    id: 3,
                    name: "Mia", // Age 5
                    age: 5,
                    emoji: "üëß",
                    totalPoints: 0,
                    todayPoints: 0,
                    lastChoreResetDate: null,
                    chores: [
                        { id: 1, name: "Make Bed (simple)", emoji: "üõèÔ∏è", points: 8, completed: false },
                        { id: 2, name: "Put Away Toys", emoji: "üß∏", points: 12, completed: false },
                        { id: 3, name: "Put Shoes Away", emoji: "üëü", points: 5, completed: false },
                        { id: 4, name: "Help Set Table (simple)", emoji: "üçΩÔ∏è", points: 8, completed: false }
                    ],
                    unlockedRewards: []
                }
            ];
            saveChildren();
        }

        // Default Activities (only if localStorage is empty)
        if (activities.length === 0) {
            activities = [
                { id: 1, name: "Build LEGOs", emoji: "üß±" },
                { id: 2, name: "Play Outside", emoji: "üå≥" },
                { id: 3, name: "Read a Book", emoji: "üìö" },
                { id: 4, name: "Draw Pictures", emoji: "üé®" },
                { id: 5, name: "Play Board Game", emoji: "üé≤" },
                { id: 6, name: "Listen to Music", emoji: "üé∂" },
                { id: 7, name: "Do a Puzzle", emoji: "üß©" }
            ];
            saveActivities();
        }

        // Define Universal Rewards (same for all children)
        const allRewards = [
            { id: 1, name: "Extra 15 min Screen Time", emoji: "üì±", cost: 50 },
            { id: 2, name: "Choose Dessert Tonight", emoji: "üç∞", cost: 100 },
            { id: 3, name: "Family Movie Night Pick", emoji: "üçø", cost: 150 },
            { id: 4, name: "Stay Up 30 min Late", emoji: "üåô", cost: 200 },
            { id: 5, name: "Small Toy/Surprise", emoji: "üéÅ", cost: 300 }
        ];

        // --- Global Variables for Modal Management ---
        let currentModalMode = ''; // 'activity' or 'chore'
        
        // --- Initialization on Load ---
        document.addEventListener('DOMContentLoaded', function() {
            populateChildSelector(); // Populate dropdown first
            
            if (children.length > 0) {
                // Select the first child by default if any exist and no child is currently active
                if (currentChildIndex === -1 || !children[currentChildIndex]) {
                    currentChildIndex = 0; 
                    document.getElementById('child-selector').value = children[currentChildIndex].id; // Set dropdown
                } else {
                    // Ensure the dropdown reflects the currently loaded child (e.g., from a saved state)
                    document.getElementById('child-selector').value = children[currentChildIndex].id;
                }
                resetChoresDaily(); // Check for daily reset for the selected child
                
                // Render content for the selected child
                renderActivitiesTab();
                renderChoresTab();
                renderRewardsTab();
                switchTab('activities'); // Start on activities tab
            } else {
                // No children found, prompt user to add one
                console.warn("No children found. Opening child management modal.");
                showChildManagementModal(true); // Open in add mode initially
                // Also hide main content until a child is added
                document.getElementById('activities').classList.add('hidden');
                document.getElementById('chores').classList.add('hidden');
                document.getElementById('rewards').classList.add('hidden');
            }

            requestNotificationPermission(); // Ask for notification permission
        });

        // --- Child Selection Logic ---
        function populateChildSelector() {
            const selector = document.getElementById('child-selector');
            selector.innerHTML = ''; // Clear existing options

            if (children.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No Children Added';
                option.disabled = true;
                option.selected = true;
                selector.appendChild(option);
                selector.disabled = true; // Disable selector if no children
                // Hide main content if no children selected
                document.getElementById('activities').classList.add('hidden');
                document.getElementById('chores').classList.add('hidden');
                document.getElementById('rewards').classList.add('hidden');
            } else {
                selector.disabled = false;
                children.forEach(child => {
                    const option = document.createElement('option');
                    option.value = child.id;
                    option.textContent = `${child.emoji} ${child.name} (Age ${child.age})`;
                    selector.appendChild(option);
                });
                // Ensure the selected child is visible on screen
                if (currentChildIndex !== -1 && children[currentChildIndex]) {
                    selector.value = children[currentChildIndex].id;
                    // Show main content tabs once a child is selected
                    document.getElementById('activities').classList.remove('hidden');
                    document.getElementById('chores').classList.remove('hidden');
                    document.getElementById('rewards').classList.remove('hidden');
                }
            }
        }

        function switchChild(childId) {
            const newIndex = children.findIndex(child => child.id == childId);
            if (newIndex !== -1) {
                currentChildIndex = newIndex;
                resetChoresDaily(); // Check for daily reset for the newly selected child
                // Re-render all relevant tabs for the new child
                renderActivitiesTab(); // Activities are global, but context might change
                renderChoresTab();
                renderRewardsTab();
                // Keep the current tab active after switch
                const activeTabButton = document.querySelector('.nav-tabs .tab.active');
                if (activeTabButton) {
                    const tabNameMatch = activeTabButton.onclick.toString().match(/'([^']+)'/);
                    if (tabNameMatch && tabNameMatch[1]) {
                        switchTab(tabNameMatch[1]);
                    } else {
                        switchTab('activities'); // Fallback
                    }
                }
            }
        }

        // Helper to get current child's data
        function getCurrentChild() {
            if (currentChildIndex === -1 || !children[currentChildIndex]) {
                return null; // Return null if no child selected or child data missing
            }
            return children[currentChildIndex];
        }

        function saveChildren() {
            localStorage.setItem('children', JSON.stringify(children));
        }

        // --- Tab Switching ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Re-render relevant tab content when switching
            if (tabName === 'chores') {
                renderChoresTab();
            } else if (tabName === 'rewards') {
                renderRewardsTab();
            } else if (tabName === 'activities') {
                renderActivitiesTab(); // Ensure active activity is shown
            }
        }

        // --- Activities Tab Logic ---
        let currentPickedActivity = null; // To display on the main activities tab

        function renderActivitiesTab() {
            const displayEmoji = document.getElementById('current-activity-emoji');
            const displayName = document.getElementById('current-activity-name');
            if (currentPickedActivity) {
                displayEmoji.textContent = currentPickedActivity.emoji;
                displayName.textContent = currentPickedActivity.name;
            } else {
                displayEmoji.textContent = '‚ùì';
                displayName.textContent = 'Let\'s Find Out!';
            }
        }

        function pickRandomActivity() {
            if (activities.length === 0) {
                document.getElementById('current-activity-emoji').textContent = 'ü§î';
                document.getElementById('current-activity-name').textContent = 'No Activities Added!';
                showNotification('No Activities', 'Please add some activities first!');
                return;
            }
            const randomIndex = Math.floor(Math.random() * activities.length);
            currentPickedActivity = activities[randomIndex];
            renderActivitiesTab();
            showNotification('New Activity!', `Time for "${currentPickedActivity.name}"!`);
            showCompletionAnimation('‚ú®'); // Re-use animation for a fun reveal
        }

        function saveActivities() {
            localStorage.setItem('activities', JSON.stringify(activities));
        }

        // --- Chores Tab Logic ---
        function renderChoresTab() {
            const currentChild = getCurrentChild();
            if (!currentChild) {
                document.getElementById('chores-list').innerHTML = `<p style="color: var(--light-text-color); text-align: center;">Please select a child to view chores.</p>`;
                document.getElementById('today-points-display').textContent = '0';
                return;
            }

            const list = document.getElementById('chores-list');
            list.innerHTML = '';
            
            document.getElementById('today-points-display').textContent = currentChild.todayPoints; // Update today's points

            if (currentChild.chores.length === 0) {
                list.innerHTML = `<p style="color: var(--light-text-color); text-align: center;">No chores for ${currentChild.name} yet!</p>`;
            } else {
                currentChild.chores.forEach(chore => {
                    const choreItem = document.createElement('div');
                    choreItem.className = 'chore-item';
                    choreItem.innerHTML = `
                        <input type="checkbox" id="chore-${chore.id}" ${chore.completed ? 'checked' : ''} onclick="markChoreComplete(${chore.id}, this.checked)">
                        <label for="chore-${chore.id}" class="${chore.completed ? 'completed' : ''}">
                            <span class="emoji">${chore.emoji}</span>
                            <span>${chore.name}</span>
                        </label>
                        <span class="points">${chore.points} pts</span>
                    `;
                    list.appendChild(choreItem);
                });
            }
        }

        function markChoreComplete(id, isCompleted) {
            const currentChild = getCurrentChild();
            if (!currentChild) return;

            const choreIndex = currentChild.chores.findIndex(c => c.id === id);
            if (choreIndex !== -1) {
                const chore = currentChild.chores[choreIndex];
                chore.completed = isCompleted; // Update completion status

                if (isCompleted) {
                    currentChild.totalPoints += chore.points;
                    currentChild.todayPoints += chore.points; // Add to today's points
                    showNotification('Chore Done!', `You earned ${chore.points} points for "${chore.name}"!`);
                    showCompletionAnimation('‚≠ê'); // Visual feedback for points
                    checkAndUnlockRewards(); // Check if new rewards are unlocked
                } else {
                    currentChild.totalPoints -= chore.points; // Deduct if unchecked
                    currentChild.todayPoints -= chore.points; // Deduct from today's points
                }
                saveChildren(); // Save all children data
                renderChoresTab(); // Re-render to update checkboxes, strike-through, and points
                renderRewardsTab(); // Update total points display
            }
        }

        function saveChores() { // This function is now effectively part of saveChildren()
            saveChildren();
        }

        function resetChores() {
            const currentChild = getCurrentChild();
            if (!currentChild) return;

            if (confirm(`Are you sure you want to reset all chores for ${currentChild.name} today? This will clear all checkboxes and reset today's points.`)) {
                currentChild.chores.forEach(chore => chore.completed = false);
                currentChild.todayPoints = 0; // Reset today's points for this child
                currentChild.lastChoreResetDate = new Date().toDateString(); // Update reset date
                saveChildren();
                renderChoresTab();
                showNotification('Chores Reset', `Chores for ${currentChild.name} reset! Time for new tasks!`);
            }
        }

        function resetChoresDaily() {
            const currentChild = getCurrentChild();
            if (!currentChild) return;

            const todayDate = new Date().toDateString();
            if (currentChild.lastChoreResetDate !== todayDate) {
                // It's a new day, reset chores and today's points for this child
                currentChild.chores.forEach(chore => chore.completed = false);
                currentChild.todayPoints = 0;
                currentChild.lastChoreResetDate = todayDate;
                saveChildren();
                console.log(`Chores for ${currentChild.name} reset for a new day.`);
            }
        }

        // --- Rewards Tab Logic ---
        function renderRewardsTab() {
            const currentChild = getCurrentChild();
            if (!currentChild) {
                document.getElementById('rewards-grid').innerHTML = `<p style="color: var(--light-text-color); text-align: center;">Please select a child to view rewards.</p>`;
                document.getElementById('total-points-display').textContent = '0';
                return;
            }

            document.getElementById('total-points-display').textContent = currentChild.totalPoints;
            const grid = document.getElementById('rewards-grid');
            grid.innerHTML = '';
            let hasUnlockableRewards = false;

            allRewards.forEach(reward => {
                const isUnlocked = currentChild.unlockedRewards.includes(reward.id);
                const rewardCard = document.createElement('div');
                rewardCard.className = `reward-card ${isUnlocked ? 'unlocked' : ''}`;
                rewardCard.innerHTML = `
                    <span class="emoji">${reward.emoji}</span>
                    <div class="name">${reward.name}</div>
                    <div class="cost">${isUnlocked ? 'UNLOCKED!' : `${reward.cost} pts`}</div>
                `;
                grid.appendChild(rewardCard);
                if (!isUnlocked && currentChild.totalPoints < reward.cost) hasUnlockableRewards = true; // Still unlockable if cost not met
            });

            if (hasUnlockableRewards) {
                document.getElementById('no-rewards-msg').classList.add('hidden');
            } else {
                document.getElementById('no-rewards-msg').textContent = "You've unlocked all current rewards! Great job!";
                document.getElementById('no-rewards-msg').classList.remove('hidden');
            }
        }

        function checkAndUnlockRewards() {
            const currentChild = getCurrentChild();
            if (!currentChild) return;

            let newRewardUnlocked = false;
            allRewards.forEach(reward => {
                if (!currentChild.unlockedRewards.includes(reward.id) && currentChild.totalPoints >= reward.cost) {
                    currentChild.unlockedRewards.push(reward.id);
                    newRewardUnlocked = true;
                    showNotification('Reward Unlocked!', `${currentChild.emoji} ${currentChild.name} unlocked: ${reward.emoji} ${reward.name}!`);
                    showCompletionAnimation('üéÅ'); // Special animation for reward
                }
            });
            if (newRewardUnlocked) {
                saveChildren(); // Save all children data
                renderRewardsTab(); // Re-render to show newly unlocked rewards
            }
        }

        function saveRewardProgress() { // This function is now effectively part of saveChildren()
            saveChildren();
        }

        // --- Universal Activity/Chore Management Modal Logic ---
        let currentModalMode = ''; // 'activity' or 'chore'

        function showManageModal(mode) {
            currentModalMode = mode;
            const modal = document.getElementById('manage-modal');
            const modalTitle = document.getElementById('modal-title');
            const itemListContainer = document.getElementById('item-list-container');
            itemListContainer.innerHTML = ''; // Clear previous items

            if (mode === 'activity') {
                modalTitle.textContent = 'Manage Activities';
                if (activities.length === 0) { // If no activities, add a default empty one
                    addNewItemToModal('activity', 'New Activity', 'üí°');
                } else {
                    activities.forEach(item => addItemToModal(item.name, item.emoji));
                }
            } else if (mode === 'chore') {
                const currentChild = getCurrentChild();
                if (!currentChild) { hideManageModal(); return; } // Should not happen if a child is selected
                modalTitle.textContent = `Manage Chores for ${currentChild.name}`;
                if (currentChild.chores.length === 0) { // If no chores for this child, add a default empty one
                    addNewItemToModal('chore', 'New Chore', 'üßπ', 10);
                } else {
                    currentChild.chores.forEach(item => addItemToModal(item.name, item.emoji, item.points));
                }
            }
            modal.classList.add('active');
        }

        function hideManageModal() {
            document.getElementById('manage-modal').classList.remove('active');
            // No need to clear currentManagedItems, as they are rebuilt in showManageModal
        }

        function addItemToModal(name = '', emoji = '‚ú®', points = null) {
            const itemListContainer = document.getElementById('item-list-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'modal-item';
            itemDiv.innerHTML = `
                <input type="text" value="${name}" placeholder="Name" aria-label="Item name">
                <span class="emoji-selector" onclick="openInlineEmojiPicker(this)">${emoji}</span>
                ${points !== null ? `<input type="number" value="${points}" placeholder="Points" min="1" aria-label="Points for chore">` : ''}
                <button class="remove-btn" onclick="removeItemFromModal(this)" aria-label="Remove item">&times;</button>
            `;
            itemListContainer.appendChild(itemDiv);
            // Auto-focus on the new input after it's added (with a slight delay for rendering)
            setTimeout(() => itemDiv.querySelector('input[type="text"]').focus(), 50);
        }

        function addNewItemToModal() {
            if (currentModalMode === 'activity') {
                addItemToModal('', '‚ú®');
            } else if (currentModalMode === 'chore') {
                addItemToModal('', 'üßπ', 10); // Default points for new chore
            }
        }

        function removeItemFromModal(button) {
            const itemListContainer = document.getElementById('item-list-container');
            if (itemListContainer.children.length > 1) { // Ensure at least one item remains
                button.closest('.modal-item').remove();
            } else {
                alert("You need at least one item in the list!");
            }
        }

        function saveManagedItems() {
            const itemListContainer = document.getElementById('item-list-container');
            const items = [];
            let isValid = true;

            Array.from(itemListContainer.children).forEach((itemDiv, index) => {
                const nameInput = itemDiv.querySelector('input[type="text"]');
                const emojiSpan = itemDiv.querySelector('.emoji-selector');
                const pointsInput = itemDiv.querySelector('input[type="number"]');

                const name = nameInput.value.trim();
                const emoji = emojiSpan.textContent;
                const points = pointsInput ? parseInt(pointsInput.value) : undefined;

                if (!name) {
                    alert(`Item ${index + 1} needs a name!`);
                    isValid = false;
                    nameInput.focus();
                    return;
                }
                if (pointsInput && (isNaN(points) || points < 1)) {
                    alert(`Item ${index + 1} needs valid points (1 or more)!`);
                    isValid = false;
                    pointsInput.focus();
                    return;
                }

                if (currentModalMode === 'activity') {
                    items.push({ id: Date.now() + index, name, emoji }); // Assign new IDs
                } else if (currentModalMode === 'chore') {
                    // When saving chores, we assign new IDs to simplify, but assume they start uncompleted.
                    // This means if a chore was completed and then you edit the list, its completion state will reset.
                    items.push({ id: Date.now() + index, name, emoji, points, completed: false });
                }
            });

            if (!isValid) return;

            if (currentModalMode === 'activity') {
                activities = items;
                saveActivities();
                renderActivitiesTab(); // Refresh the display on the main tab
            } else if (currentModalMode === 'chore') {
                const currentChild = getCurrentChild();
                if (!currentChild) return;
                
                currentChild.chores = items; 
                saveChildren();
                renderChoresTab(); // Refresh the display on the main tab
            }

            hideManageModal();
        }

        // --- Inline Emoji Picker Logic (for activities/chores in manage-modal) ---
        // Cycles through a subset of emojis
        const inlineEmojis = [
            '‚ú®', 'üí°', 'üßπ', 'üìö', 'ü§∏', 'üé≤', 'üé®', 'üß©', 'üå≥', 'üì±', 'üõèÔ∏è', 'ü¶∑', 'üß∏', 'üçΩÔ∏è', 'üç≥', 'üíß', 'üß∫', 'üêæ', 'üëï', 'üëü',
            'üòä', 'üëç', 'üí™', 'üåà', 'üåü', 'üéâ', 'üçé', 'ü•ï', 'üöø', 'üõÄ', 'üé§', 'üöó', '‚òÄÔ∏è', 'üåô', '‚≠ê', '‚ù§Ô∏è'
        ];
        
        function openInlineEmojiPicker(spanElement) {
            const currentEmoji = spanElement.textContent;
            const currentIndex = inlineEmojis.indexOf(currentEmoji);
            const nextIndex = (currentIndex + 1) % inlineEmojis.length;
            spanElement.textContent = inlineEmojis[nextIndex];
        }

        // --- NEW: Child Management Modal Logic ---
        // Emojis for Child Profile selection (can be a larger set if desired)
        const childEmojis = [
            'üëß', 'üßí', 'üë¶', 'üßë', 'üë∂', 'üëº', 'üë±‚Äç‚ôÄÔ∏è', 'üë®‚Äçü¶∞', 'üë©‚Äçü¶∞', 'üßö', 'üßú‚Äç‚ôÄÔ∏è', 'ü¶∏', 'üßô‚Äç‚ôÄÔ∏è', 'üë®‚Äçüéì', 'üë©‚Äçüíª', 'üêæ', 'üêº', 'ü¶Ñ', 'üåà', '‚≠êÔ∏è'
        ];
        let currentSelectedChildEmoji = 'üëß'; // Default for new child form
        let childEmojiDisplayElement = null; // Reference to the button showing current emoji

        function showChildManagementModal(addingNew = false) {
            const modal = document.getElementById('child-management-modal');
            const nameInput = document.getElementById('child-name-input');
            const ageInput = document.getElementById('child-age-input');
            const saveBtn = document.getElementById('save-child-btn');
            childEmojiDisplayElement = document.getElementById('child-emoji-display'); // Get the emoji display button
            const childEmojiPicker = document.getElementById('child-emoji-picker');

            // Reset form for adding new child
            nameInput.value = '';
            ageInput.value = '';
            editingChildId = null; // Not editing initially

            saveBtn.textContent = 'Add Child';
            currentSelectedChildEmoji = 'üëß'; // Default new child emoji
            childEmojiDisplayElement.textContent = currentSelectedChildEmoji; // Set display

            // Populate the full emoji picker grid
            childEmojiPicker.innerHTML = '';
            childEmojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-option';
                btn.type = 'button'; // Prevent form submission
                btn.textContent = emoji;
                btn.setAttribute('data-emoji', emoji);
                btn.onclick = () => selectChildEmoji(emoji);
                childEmojiPicker.appendChild(btn);
            });
            // Select the default emoji
            selectChildEmoji('üëß');

            renderChildListForManagement(); // Always render the list of existing children
            modal.classList.add('active');
            nameInput.focus();
        }

        function hideChildManagementModal() {
            document.getElementById('child-management-modal').classList.remove('active');
            editingChildId = null; // Clear editing state
            // If no children exist after closing, ensure main content is hidden
            if (children.length === 0) {
                 document.getElementById('activities').classList.add('hidden');
                 document.getElementById('chores').classList.add('hidden');
                 document.getElementById('rewards').classList.add('hidden');
            }
        }

        function selectChildEmoji(emoji) {
            currentSelectedChildEmoji = emoji;
            document.querySelectorAll('#child-emoji-picker .emoji-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.emoji === emoji) {
                    opt.classList.add('selected');
                }
            });
            if (childEmojiDisplayElement) {
                 childEmojiDisplayElement.textContent = emoji; // Update the main display button
            }
        }

        function renderChildListForManagement() {
            const listContainer = document.getElementById('children-list-management');
            const noChildrenMsg = document.getElementById('no-children-msg');
            listContainer.innerHTML = '';

            if (children.length === 0) {
                noChildrenMsg.classList.remove('hidden');
            } else {
                noChildrenMsg.classList.add('hidden');
                children.forEach(child => {
                    const childItem = document.createElement('div');
                    childItem.className = 'modal-item';
                    childItem.innerHTML = `
                        <span style="font-size: 1.2rem;">${child.emoji}</span>
                        <span>${child.name} (Age ${child.age})</span>
                        <button class="edit-btn" onclick="editChild(${child.id})" title="Edit ${child.name}">‚úèÔ∏è</button>
                        <button class="remove-btn" onclick="deleteChild(${child.id})" title="Delete ${child.name}">&times;</button>
                    `;
                    listContainer.appendChild(childItem);
                });
            }
        }

        function editChild(id) {
            const childToEdit = children.find(child => child.id === id);
            if (!childToEdit) return;

            editingChildId = id;
            document.getElementById('child-name-input').value = childToEdit.name;
            document.getElementById('child-age-input').value = childToEdit.age;
            document.getElementById('save-child-btn').textContent = 'Update Child';
            selectChildEmoji(childToEdit.emoji); // Select the correct emoji in the picker

            // Scroll to top of modal to show form
            document.getElementById('child-management-modal').querySelector('.modal-content').scrollTop = 0;
            document.getElementById('child-name-input').focus();
        }

        function deleteChild(id) {
            const childToDelete = children.find(child => child.id === id);
            if (!childToDelete) return;

            if (confirm(`Are you sure you want to delete ${childToDelete.name} and ALL their data (chores, points, rewards)? This cannot be undone.`)) {
                children = children.filter(child => child.id !== id);
                saveChildren();
                
                // If the deleted child was the current child, switch to first child or handle no children
                if (!children.find(child => child.id === childToDelete.id)) { // Check if it was successfully removed
                    if (children.length > 0) {
                        currentChildIndex = 0;
                    } else {
                        currentChildIndex = -1; // No children left
                    }
                }
                
                populateChildSelector(); // Update dropdown
                renderChildListForManagement(); // Update list in modal
                // Refresh main content based on new currentChild (or lack thereof)
                switchTab(document.querySelector('.nav-tabs .tab.active')?.onclick.toString().match(/'([^']+)'/)?.[1] || 'activities');
            }
        }

        function saveChild() {
            const name = document.getElementById('child-name-input').value.trim();
            const age = parseInt(document.getElementById('child-age-input').value);
            const emoji = currentSelectedChildEmoji;

            if (!name) {
                alert('Please enter a child\'s name.');
                return;
            }
            if (isNaN(age) || age < 1 || age > 18) {
                alert('Please enter a valid age (1-18).');
                return;
            }

            if (editingChildId) {
                // Update existing child
                const index = children.findIndex(child => child.id === editingChildId);
                if (index !== -1) {
                    children[index].name = name;
                    children[index].age = age;
                    children[index].emoji = emoji;
                    // No need to reset chores/points here, just name/age/emoji
                }
            } else {
                // Add new child
                const newChild = {
                    id: Date.now(),
                    name,
                    age,
                    emoji,
                    totalPoints: 0,
                    todayPoints: 0,
                    lastChoreResetDate: null,
                    chores: [], // New child starts with no chores
                    unlockedRewards: []
                };
                // Pre-populate with default chores for new children based on age
                const defaultNewChildChores = [];
                if (age >= 8) {
                    defaultNewChildChores.push(
                        { id: Date.now() + 10, name: "Make Bed", emoji: "üõèÔ∏è", points: 10, completed: false },
                        { id: Date.now() + 11, name: "Brush Teeth", emoji: "ü¶∑", points: 5, completed: false },
                        { id: Date.now() + 12, name: "Load Dishwasher", emoji: "üß∫", points: 20, completed: false },
                        { id: Date.now() + 13, name: "Tidy Room", emoji: "üßπ", points: 15, completed: false }
                    );
                } else if (age >= 6) {
                    defaultNewChildChores.push(
                        { id: Date.now() + 20, name: "Make Bed", emoji: "üõèÔ∏è", points: 10, completed: false },
                        { id: Date.now() + 21, name: "Brush Teeth", emoji: "ü¶∑", points: 5, completed: false },
                        { id: Date.now() + 22, name: "Put Away Toys", emoji: "üß∏", points: 15, completed: false },
                        { id: Date.now() + 23, name: "Put Clothes in Hamper", emoji: "üëï", points: 10, completed: false }
                    );
                } else { // Age 1-5 (default for younger)
                    defaultNewChildChores.push(
                        { id: Date.now() + 30, name: "Make Bed (simple)", emoji: "üõèÔ∏è", points: 8, completed: false },
                        { id: Date.now() + 31, name: "Put Away Toys", emoji: "üß∏", points: 12, completed: false },
                        { id: Date.now() + 32, name: "Put Shoes Away", emoji: "üëü", points: 5, completed: false }
                    );
                }
                newChild.chores = defaultNewChildChores;
                children.push(newChild);
                currentChildIndex = children.length - 1; // Select newly added child
            }

            saveChildren();
            populateChildSelector(); // Update the main dropdown
            renderChildListForManagement(); // Refresh the list in the modal
            
            // Reset form and UI for next action (add another or close)
            document.getElementById('child-name-input').value = '';
            document.getElementById('child-age-input').value = '';
            selectChildEmoji('üëß'); // Reset emoji selection
            editingChildId = null;
            document.getElementById('save-child-btn').textContent = 'Add Child';
            document.getElementById('child-name-input').focus();
            
            // If modal was opened because no children existed, hide it now that one is added
            if (children.length > 0 && !document.getElementById('activities').classList.contains('active')) {
                hideChildManagementModal();
                switchTab('activities'); // Go to default tab
            }
        }

        // --- General Utility Functions ---
        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body, icon: '/icons/icon-192x192.png' }); // Use your PWA icon
            }
        }

        function showCompletionAnimation(emoji = '‚ú®') {
            const animation = document.createElement('div');
            animation.className = 'completion-animation';
            animation.textContent = emoji;
            document.body.appendChild(animation);
            
            setTimeout(() => {
                if (document.body.contains(animation)) {
                    document.body.removeChild(animation);
                }
            }, 1000);
        }

        // Keyboard navigation accessibility (visual focus indicator)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-navigation');
            }
        });

        document.addEventListener('mousedown', function() {
            document.body.classList.remove('keyboard-navigation');
        });

        // Service Worker registration (kept at the end of the body)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered! Scope:', registration.scope);
                    })
                    .catch(err => {
                        console.error('Service Worker registration failed:', err);
                    });
            });
        }
    </script>
</body>
</html>